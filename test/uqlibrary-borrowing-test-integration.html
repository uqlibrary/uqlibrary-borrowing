<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>uqlibrary-borrowing</title>

  <script src="../../webcomponentsjs/webcomponents.min.js"></script>
  <script src="../../web-component-tester/browser.js"></script>

  <link rel="import" href="../uqlibrary-borrowing.html">
</head>
<body>

<uqlibrary-borrowing autoload="false"></uqlibrary-borrowing>

<script>
window.addEventListener('polymer-ready', function() {
  var borrowingEl = document.querySelector('uqlibrary-borrowing');
  var dataLoadedEventListeners = [];

  describe('uqlibrary-borrowing', function () {
    before(function () {
    });

    afterEach(function () {

      //remove all previous listeners
      for(var i=0; i< dataLoadedEventListeners.length; i++) {
        borrowingEl.removeEventListener('uqlibrary-borrowing-data-loaded', dataLoadedEventListeners[i]);
      }
    });

     describe('data loaded', function () {
     it('should display tabs with data', function(done) {

       var dataLoadedListener = function() {
         // check block visibility asynchronously
         setTimeout(function() {
           var tabs = borrowingEl.$.tabs.querySelectorAll('paper-tab');
           assert.isNotNull(tabs, 'Tabs are not visible');

           // Check all tabs are shown
           expect(tabs.length).to.be.equal(3);
           var _title = tabs[0].querySelector('.tabTitle');
           var _titleNumber = tabs[0].querySelector('.tabTitleNumber');
           expect(_title.innerHTML).to.be.equal('Loans');
           expect(_titleNumber.innerHTML).to.be.equal(borrowingEl.data.checkedOut.length+'');

           var _title = tabs[1].querySelector('.tabTitle');
           var _titleNumber = tabs[1].querySelector('.tabTitleNumber');
           expect(_title.innerHTML).to.be.equal('Holds');
           expect(_titleNumber.innerHTML).to.be.equal(borrowingEl.data.holds.length+'');

           var _title = tabs[2].querySelector('.tabTitle');
           var _titleNumber = tabs[2].querySelector('.tabTitleNumber');
           expect(_title.innerHTML).to.be.equal('Overdue Charges');
           expect(_titleNumber.innerHTML).to.be.equal(borrowingEl.$.fines.moneyFormat(borrowingEl.$.fines.finesSum)+'');

           expect(borrowingEl.selectedTab).to.be.equal('loans');

           var isHoldsHidden = borrowingEl.$.holdsSection.getAttribute('hidden');
           assert.isNotNull(isHoldsHidden, 'Holds tab is not hidden');

           var isFinesHidden = borrowingEl.$.finesSection.getAttribute('hidden');
           assert.isNotNull(isFinesHidden, 'Fines tab is not hidden');


           var _list = borrowingEl.$.loans.$.loansTimeline;

           expect(_list.processedItems.length).to.be.equal(borrowingEl.data.checkedOut.length);

           var isHidden = _list.$.emptyItems.getAttribute('hidden');
           assert.isNotNull(isHidden, 'No Loans message is hidden');


           var firstItem = _list.$.timeline.querySelector('li.first');
           assert.isNotNull(firstItem, 'No first item shown');

           var _date = firstItem.querySelector('div.title');
           expect(_date.innerHTML).to.contain(_list.processedItems[0].day);

           var _title = firstItem.querySelector('div.line1');
           expect(_title.innerHTML).to.contain(_list.processedItems[0].title);

           var isFooterHidden = borrowingEl.$.holds.$.persistentFooter.getAttribute('hidden');;
           assert.isNull(isFooterHidden, 'Persistent footer is not visible');

           // Switch to holds tab
           borrowingEl.selectedTab = 'holds';
           setTimeout(function() {
             var _list = borrowingEl.$.holds.$.holdsTimeline;
             var isHoldsHidden = borrowingEl.$.loansSection.getAttribute('hidden');
             assert.isNotNull(isHoldsHidden, 'Holds tab is not hidden');

             var isFinesHidden = borrowingEl.$.finesSection.getAttribute('hidden');
             assert.isNotNull(isFinesHidden, 'Fines tab is not hidden');

             expect(_list.processedItems.length).to.be.equal(borrowingEl.data.holds.length);

             var firstItem = _list.$.timeline.querySelector('li.first');
             assert.isNotNull(firstItem, 'No first item shown');

             var _texts = firstItem.querySelectorAll('div.caption');
             expect(_texts[0].innerHTML).to.contain('Ready');
             expect(_texts[1].innerHTML).to.contain('for pickup');

             var _title = firstItem.querySelector('div.line1');
             expect(_title.innerHTML).to.contain(_list.processedItems[0].title);

             var isFooterHidden = borrowingEl.$.holds.$.persistentFooter.getAttribute('hidden');;
             assert.isNull(isFooterHidden, 'Persistent footer is not visible');

             // Switch to fines tab
             borrowingEl.selectedTab = 'fines';
             setTimeout(function() {
               var _list = borrowingEl.$.fines.$.finesList;

               var isLoansHidden = borrowingEl.$.loansSection.getAttribute('hidden');
               assert.isNotNull(isLoansHidden, 'Loans tab is not hidden');

               var isHoldsHidden = borrowingEl.$.holdsSection.getAttribute('hidden');
               assert.isNotNull(isHoldsHidden, 'Holds tab is not hidden');

               expect(_list.processedItems.length).to.be.equal(borrowingEl.data.fines.length);

               var firstItem = _list.$.timeline.querySelector('li.first');
               assert.isNotNull(firstItem, 'No first item shown');

               var _amount = firstItem.querySelector('div.title');
               expect(_amount.innerHTML).to.contain(borrowingEl.$.fines.moneyFormat(_list.processedItems[0].fineAmount));

               var _text = firstItem.querySelector('div.line1');
               expect(_text.innerHTML).to.contain(_list.processedItems[0].title);

               _text = firstItem.querySelector('div.line2');
               expect(_text.innerHTML).to.contain('Due date');

               _text = firstItem.querySelector('div.line3');
               expect(_text.innerHTML).to.contain('Date returned');

               var isFooterHidden = borrowingEl.$.fines.$.persistentFooter.getAttribute('hidden');
               assert.isNull(isFooterHidden, 'Persistent footer is not visible');

               expect(borrowingEl.$.fines.$.persistentFooter.innerHTML).to.contain(borrowingEl.$.fines.moneyFormat(borrowingEl.$.fines.finesSum))

               done();
             }, 2000);


             //done();
           }, 2000);


         }, 2000);
       };
       borrowingEl.addEventListener('uqlibrary-borrowing-data-loaded', dataLoadedListener);
       dataLoadedEventListeners.push(dataLoadedListener);

       borrowingEl.$.loansApi.get();

     });
  });
  });

});
</script>

</body>
</html>

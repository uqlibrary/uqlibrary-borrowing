<!--
Element providing an overview for loans, holds and fines.

##### Example

    <uqlibrary-borrowing></uqlibrary-borrowing>

    <script>
      window.addEventListener('polymer-ready', function() {

        var borrowing = document.querySelector('uqlibrary-borrowing');

        borrowing.data = {
          "checkedOut": [
            {
              "title": "Pharmaceutics : the science of dosage form design",
              "dueDate": "2014-12-06T04:00:00+10:00",
              "url": "http:\/\/library.uq.edu.au\/record=i3349004"
            },
          ],
          "holds": [
            {
              "title": "Regression analysis of count data",
              "datePlaced": "2014-11-22T14:00:00+10:00",
              "url": "http:\/\/library.uq.edu.au\/record=i2673780",
              "status": 'onHold'
            },
            {
              "title": "Regression analysis of count data. Part 2",
              "datePlaced": "2014-02-12T14:00:00+10:00",
              "url": "http:\/\/library.uq.edu.au\/record=i2673780",
              "pickupLocation": 'BSL - Level 3',
              "status": 'itemReady'
            },
          ],
          "fines": [
            {
              "title": "1. Human physiology : from cells to systems \/ Lauralee Sherwood.",
              "fineAmount": 840,
              "dueDate": "2014-04-08T04:00:00+10:00",
              "dateReturned": "2014-04-14T14:02:05+10:00",
              "dateAssessed": "2014-04-15T14:02:05+10:00",
              "description": "Book loan overdue",
              "fineType": "overdue",
              "url": "http:\/\/library.uq.edu.au\/record=i3698283"
            },
            {
              "title": "2. Human physiology : from cells to systems \/ Lauralee Sherwood.",
              "fineAmount": 160,
              "dueDate": "2013-04-22T04:00:00+10:00",
              "dateReturned": "2013-04-24T14:44:15+10:00",
              "dateAssessed": "2013-04-25T14:02:05+10:00",
              "description": "Book loan overdue and slight damage",
              "fineType": "overdue",
              "url": "http:\/\/library.uq.edu.au\/record=i3704585"
            },
          ],
        };

      });
    }());
    </script>

@element uqlibrary-borrowing
@blurb Element providing an overview for loans, holds and fines.
@status alpha
@homepage http://uqlibrary.github.io/uqlibrary-borrowing
-->

<link rel="import" href="../uqlibrary-elements/0.5.5/lib/vulcanized.html">

<link rel="import" href="uqlibrary-holds.html">
<link rel="import" href="uqlibrary-loans.html">
<link rel="import" href="uqlibrary-fines.html">


<polymer-element name="uqlibrary-borrowing" layout center attributes="data autoload">
  <template>
    <link rel="stylesheet" href="../uqlibrary-elements/resources/theme/element.css">
    <link rel="stylesheet" href="uqlibrary-borrowing.css">

    <uqlibrary-api-account id="account"></uqlibrary-api-account>
    <uqlibrary-api-account-loans id="loansApi"></uqlibrary-api-account-loans>

    <uqlibrary-ga id="ga" appName="Borrowing"></uqlibrary-ga>

    <core-drawer-panel id="drawerPanel" class="drawer" drawerWidth="256px" responsiveWidth="768px">

      <core-header-panel drawer>
        <uqlibrary-menu id="uqlibraryMenu" account="{{user}}"></uqlibrary-menu>
      </core-header-panel>

      <core-header-panel main class="main">
        <core-toolbar>
          <core-a11y-keys id="a11yToolBarLeftButton" target="{{$.toolBarLeftButton}}" keys="{{keyboardNavigationKeys}}"
                          on-keys-pressed="{{ a11yKeyPressed }}"></core-a11y-keys>
          <paper-icon-button id="toolBarLeftButton" icon="menu" core-drawer-toggle></paper-icon-button>
          <h1 flex id="toolbar-page-title">Borrowing</h1>
        </core-toolbar>

        <div id="content">


          <paper-tabs id="tabs" selected="{{ selectedTab }}" on-core-select="{{ tabSelected }}">

            <core-a11y-keys id="a11yLoansTab" target="{{$.loansTab}}" keys="{{keyboardNavigationKeys}}" on-keys-pressed="{{tabLoanSelected}}"></core-a11y-keys>
            <core-a11y-keys id="a11yHoldsTab" target="{{$.holdsTab}}" keys="{{keyboardNavigationKeys}}" on-keys-pressed="{{tabHoldsSelected}}"></core-a11y-keys>
            <core-a11y-keys id="a11yFinesTab" target="{{$.finesTab}}" keys="{{keyboardNavigationKeys}}" on-keys-pressed="{{tabFinesSelected}}"></core-a11y-keys>

            <paper-tab name="loans" id="loansTab" aria-label="loans" hidden?="{{ hideLoans }}">
                <div layout vertical center class="menu">
                  <a href="javascript:;" layout vertical center>
                    <span class="tabTitleNumber">{{ data.checkedOut.length }}</span>
                    <span class="tabTitle">Loans</span>
                  </a>
                </div>
            </paper-tab>


            <paper-tab name="holds" id="holdsTab" aria-label="holds" hidden?="{{ hideHolds }}">
              <div layout vertical center class="menu">
                <a href="javascript:;" layout vertical center>
                  <span class="tabTitleNumber">{{ data.holds.length }}</span>
                  <span class="tabTitle">Holds</span>
                </a>
              </div>

            </paper-tab>
            <paper-tab name="fines" id="finesTab" aria-label="overdue charges" hidden?="{{ hideFines }}">
              <div layout vertical center class="menu">
                <a href="javascript:;" layout vertical center>
                  <span class="tabTitleNumber">{{ sumFines }}</span>
                  <span class="tabTitle">Overdue Charges</span>
                </a>
              </div>

            </paper-tab>
          </paper-tabs>

          <div class="infoWrapper">
            <core-animated-pages id="animatedPages" transitions="slide-from-right" block selected="{{selectedTab}}" valueattr="name"
                                 on-core-animated-pages-transition-prepare="{{transitionPrepareHandler}}"
                                 on-core-animated-pages-transition-end="{{transitionEndHandler}}">

              <section id="loansSection" name="loans" class="loans" hidden?="{{ selectedTab != 'loans' || hideLoans }}">
                <uqlibrary-loans id="loans" loans="{{ data.checkedOut }}"></uqlibrary-loans>
              </section>

              <section id="holdsSection" name="holds" class="holds" hidden?="{{ selectedTab != 'holds' || hideHolds }}">
                <uqlibrary-holds id="holds" holds="{{ data.holds }}"></uqlibrary-holds>
              </section>

              <section id="finesSection" name="fines" class="fines" hidden?="{{ selectedTab != 'fines' || hideFines }}">
                <uqlibrary-fines id="fines" fines="{{ data.fines }}"></uqlibrary-fines>
              </section>

           </core-animated-pages>
           </div>

        </div>
      </core-header-panel>
    </core-drawer-panel>
  </template>

  <script>
    Polymer('uqlibrary-borrowing', {

      // Accessibility issues fixes

      keyboardNavigationKeys: 'space enter',

      a11yKeyPressed: function(source, event) {
        if (source.path && source.path.length > 0 && source.path[0].target) {
          source.path[0].target.fire("tap");
        }
      },

      /**
       * The `data` attribute contains information about loans, holds and fines
       *
       * @property data
       * @type Object
       */

      publish: {
        data : {
          holds: [],
          loans: [],
          fines: []
        },
        autoload: true
      },
      sumFines : 0,
      selectedTab : 'loans',
      patronNumber: '',
      user: {},
      hideLoans: false,
      hideHolds: false,
      hideFines: false,

      ready: function() {
        var that = this;

        this.$.account.addEventListener('uqlibrary-api-account-loaded', function(e) {
          if (e.detail.hasSession) {
              that.user = e.detail;
              that.$.loansApi.get();
          } else {
            // Not logged in
            that.$.account.login(window.location.href);
          }
        });

        if(this.autoload){
          this.$.account.get();
        }

        this.$.uqlibraryMenu.addEventListener('uqlibrary-menu-loaded', function(e) {
          var borrowingData = that.$.uqlibraryMenu.applications.filter(function (element) {
            return element.app == 'uqlibrary-borrowing';
          })[0];

          if (borrowingData && borrowingData.subApplications) {
            that.hideLoans = borrowingData.subApplications.filter(function (element) {
              return element.app == 'Loans';
            })[0].ptypes.indexOf(Number(that.user.type)) == -1;
            that.hideHolds = borrowingData.subApplications.filter(function (element) {
              return element.app == 'Holds';
            })[0].ptypes.indexOf(Number(that.user.type)) == -1;
            that.hideFines = borrowingData.subApplications.filter(function (element) {
              return element.app == 'Fines';
            })[0].ptypes.indexOf(Number(that.user.type)) == -1;
          }

          if (!that.hideLoans) {
            that.selectedTab = 'loans';
          } else if (!that.hideHolds) {
            that.selectedTab = 'holds';
          } else if (!that.hideFines) {
            that.selectedTab = 'fines';
          }

        });
        this.$.loansApi.addEventListener('uqlibrary-api-account-loans-loaded', function(e) {
          that.data = e.detail;
        });

        // Listen to persistent footer buttons clicks
        this.addEventListener('uqlibrary-persistent-footer-action-button-clicked', function(e) {
          this.$.ga.addEvent('Action button clicked', e.detail.button.title);
        });

        // Listen to persistent footer buttons clicks
        this.addEventListener('uqlibrary-borrowing-contextual-button-clicked', function(e) {
          this.$.ga.addEvent('Contextual button clicked', e.detail.button.id);
        });


      },

      dataChanged: function() {
          if (this.user) {
              this.processData();
          }
      },

      processData: function () {

        this.sumFines = this.$.fines.moneyFormat(this.$.fines.calculateFines(this.data.fines));
        var patronNumber = this.data.recordNumber;

        //Contextual and footer links
        this.$.holds.actionButtons = {footer: [], contextual: []};
        if(this.data.checkedOut && this.data.checkedOut.length > 0){
          this.$.loans.actionButtons = {
            footer: [{title: 'Renew Loans', url: 'https://library.uq.edu.au/patroninfo~S7/' + patronNumber + '/items'}]
          };
        }
        // Support different contextual links
        this.$.loans.actionButtons.contextual = [{title: 'Your borrowing rights and limits', url: 'https://www.library.uq.edu.au/borrowing-requesting/borrowing-rules', id: 'borrowingGuide'}];

        this.$.holds.actionButtons = {footer: [], contextual: []};
        if(this.data.holds && this.data.holds.length > 0){
          this.$.holds.actionButtons.footer = [ {title: 'Manage Holds', url: 'https://library.uq.edu.au/patroninfo~S7/' + patronNumber + '/holds'}];
        }
        this.$.holds.actionButtons.contextual = [{title: 'About placing a hold', url: 'https://www.library.uq.edu.au/help/place-hold', id: 'aboutPlacingHold'}];

        this.$.fines.actionButtons = {footer: [], contextual: []};
        this.$.fines.patronNumber = patronNumber;
        if(this.data.fines && this.data.fines.length > 0){
//          this.$.fines.actionButtons.footer = [{title: 'Pay now', url: 'https://library.uq.edu.au/patroninfo~S7/' + patronNumber + '/overdues'}];
        }
        this.$.fines.actionButtons.contextual = [
            {title: 'About overdue charges', url: 'https://www.library.uq.edu.au/help/borrowing#overdues', id: 'aboutOverdueCharges'},
            {title: 'Payment options', url: 'https://www.library.uq.edu.au/help/payment-options', id: 'paymentOptions'}

        ];

        this.fire('uqlibrary-borrowing-data-loaded');

      },

      transitionPrepareHandler: function() {
        this.transitioning = true;
        this.fire('core-signal', {name: "transitioning-change", data: {transitioning: this.transitioning}});
      },
      transitionEndHandler: function() {
        this.transitioning = false;
        this.fire('core-signal', {name: "transitioning-change", data: {transitioning: this.transitioning}});
      },

      selectedTabChanged: function() {
        this.$.ga.addEvent('Tab changed', this.selectedTab);
      }

    });
  </script>

</polymer-element>
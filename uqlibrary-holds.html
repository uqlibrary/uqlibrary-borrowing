<link rel="import" href="../uqlibrary-elements/0.5.2/lib/vulcanized.html">
<link rel="import" href="uqlibrary-borrowing-list.html">

<polymer-element name="uqlibrary-holds" attributes="holds" extends="uqlibrary-borrowing-list">

  <template>
    <link rel="stylesheet" href="uqlibrary-borrowing.css">
    <core-signals on-core-signal-transitioning-change="{{transitioningChangeHandler}}"></core-signals>
    <section name="list">
      <uqlibrary-borrowing-list id="holdsTimeline" items="{{holds}}">
      </uqlibrary-borrowing-list>
    </section>
    <uqlibrary-persistent-footer actionButtons="{{actionButtons}}"></uqlibrary-persistent-footer>

  </template>

  <script>
    Polymer('uqlibrary-holds', {

      publish: {
        holds: {
          value : [],
          reflect : true
        }
      },
      transitioning: false,
      actionButtons: [],

      ready: function(){
        this.$.holdsTimeline.noItemsMessage = "No current holds";
        this.actionButtons.push(
          {
            id: 'cancelHolds',
            title: 'Cancel Holds',
            url: 'http://www.library.uq.edu.au'
          }
        );
        this.$.holdsTimeline.showEachDate = true;
        this.$.holdsTimeline.sortByDate = false; // we don't care about placed date, so disable sorting by date
      },

      holdsChanged: function(){
        this.processData();

      },

      processData: function() {
        var _holds = [];

        for (var i = 0; i < this.holds.length; i++) {

          var _hold = this.holds[i];
          _hold.class = '';
          _hold.id = i;
          _hold.date = new Date(_hold.datePlaced);
          _hold.dateText = _hold.date.getDate() + '/' + (_hold.date.getMonth() + 1) + '/' + _hold.date.getFullYear();
          _hold.actions = [];

          if(_hold.status == 'bibReady' || _hold.status == 'itemReady') {
            _hold.dayPrefixText = 'Ready for';
            _hold.daySuffixText = 'pickup';
            _hold.day = '';
            _hold.subtitle = 'Pickup location: ' + _hold.pickupLocation;
          } else if (_hold.status == 'itemTransit') {

            _hold.dayPrefixText = 'In';
            _hold.daySuffixText = 'transit';
            _hold.day = '';
            _hold.subtitle = 'In transit to pickup location: '+_hold.pickupLocation;
          }
          else {
            _hold.dayPrefixText = 'On';
            _hold.daySuffixText = 'Hold';
            _hold.day = '';
            _hold.subtitle = 'Date placed: '+ _hold.dateText;
          }
          /*var today = new Date();
          var overdue = Math.ceil((_hold.date - today) / (1000 * 60 * 60 * 24));

          _hold.daysRemain = -1;
          if(overdue < 0) {
            //_hold.isOverdue = true;
            //_hold.attentionIcon = {icon: "warning", text: "This item is ready for pick up", type: 'warning'};
            _hold.dayPrefixText = 'Ready';
            _hold.day = '';
            _hold.daySuffixText = 'Now';
            //_hold.class += ' warning';
            //_loan.daysOverdue = Math.abs(overdue);
            //this.data.loansOverdue ++;
          }
          else if(overdue >= 0 && overdue < 5 ) {
            //_loan.daysRemain = overdue;
            _hold.attentionIcon = {icon: "warning", text: "This item will be available in " + overdue + " day(s)", type: 'warning'};
            //this.data.dueSoon ++;
          }*/
        }

        // Sort by status
        this.holds.sort(function (a, b) {
          var statusOrder = {itemReady: 0, bibReady: 0, itemTransit: 5, onHold: 10};
          if (statusOrder[a.status] > statusOrder[b.status] ) {
            return 1;
          }
          if (statusOrder[b.status] > statusOrder[a.status]) {
            return -1;
          }
          return 0;
        });
      },

      transitioningChangeHandler: function(e) {
        if(e.detail.hasOwnProperty('transitioning'))
          this.transitioning = e.detail.transitioning;
      }

    });

  </script>

</polymer-element>
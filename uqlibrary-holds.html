<link rel="import" href="../uqlibrary-elements/0.5.4/lib/vulcanized.html">

<link rel="import" href="uqlibrary-borrowing-list.html">

<polymer-element name="uqlibrary-holds" attributes="holds actionButtons" extends="uqlibrary-borrowing-list">

  <template>
    <link rel="stylesheet" href="../uqlibrary-elements/resources/theme/element.css">
    <core-signals on-core-signal-transitioning-change="{{transitioningChangeHandler}}"></core-signals>
    <section name="list" class="body-footer-container">
      <uqlibrary-borrowing-list id="holdsTimeline" items="{{holds}}" class="with-persistent-footer">
      </uqlibrary-borrowing-list>
      <div layout horizontal>
        <template repeat="{{button in actionButtons.contextual}}">
          <div class="text-container">
            <a href="{{button.url}}" target="_blank" id="{{button.id}}" on-click="{{contextualButtonClicked}}"><core-icon class="link" icon="info-outline"></core-icon>{{button.title}}</a>
          </div>
        </template>
      </div>
    </section>
    <uqlibrary-persistent-footer id="persistentFooter" actionButtons="{{actionButtons.footer}}" hidden?="{{ actionButtons.footer.length == 0 }}"></uqlibrary-persistent-footer>

  </template>

  <script>
    Polymer('uqlibrary-holds', {

      publish: {
        holds: {
          value : [],
          reflect : true
        },
        actionButtons: {footer: [], contextual: []}
      },
      transitioning: false,

      ready: function(){
        this.$.holdsTimeline.noItemsMessage = "No current holds";
        this.$.holdsTimeline.showEachDate = true;
        this.$.holdsTimeline.sortByDate = false; // we don't care about placed date, so disable sorting by date

        this.addEventListener('uqlibrary-borrowing-list-item-selected', function(e) {
          var _item = e.detail;
          if(_item.hasOwnProperty('url')) {
            window.location.href = _item.url;
          }
        });

      },

      holdsChanged: function(){
        this.processData();

      },

      processData: function() {
        var _holds = [];

        for (var i = 0; i < this.holds.length; i++) {

          var _hold = this.holds[i];
          _hold.class = 'hold-item';
          _hold.id = i;
          _hold.date = new Date(_hold.datePlaced);
          _hold.dateText = _hold.date.getDate() + '/' + (_hold.date.getMonth() + 1) + '/' + _hold.date.getFullYear();
          //_hold.actions = [];

          if(_hold.status == 'bibReady' || _hold.status == 'itemReady') {
            _hold.dayPrefixText = 'Ready';
            _hold.day = '';
            _hold.daySuffixText = 'for pickup';
            if(_hold.pickupLocation){
              _hold.subtitle = 'Pickup location: ' + _hold.pickupLocation;
            }
          } else if (_hold.status == 'itemTransit') {

            _hold.dayPrefixText = 'Transit';
            _hold.day = '';
            _hold.daySuffixText = 'for pickup';
            _hold.subtitle = '';
            if(_hold.pickupLocation){
              _hold.secondaryText = 'Pickup location: ' + _hold.pickupLocation;
            }
          }
          else {
            _hold.dayPrefixText = 'On';
            _hold.daySuffixText = 'Hold';
            _hold.day = '';
            _hold.subtitle = 'Date placed: '+ _hold.dateText;
          }
        }

        // Sort by status
        this.holds.sort(function (a, b) {
          var statusOrder = {itemReady: 0, bibReady: 0, itemTransit: 5, onHold: 10};
          if (statusOrder[a.status] > statusOrder[b.status] ) {
            return 1;
          }
          if (statusOrder[b.status] > statusOrder[a.status]) {
            return -1;
          }
          return 0;
        });
      },

      transitioningChangeHandler: function(e) {
        if(e.detail.hasOwnProperty('transitioning'))
          this.transitioning = e.detail.transitioning;
      }

    });

  </script>

</polymer-element>
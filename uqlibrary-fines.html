<link rel="import" href="../uqlibrary-elements/0.5.4/lib/vulcanized.html">
<link rel="import" href="uqlibrary-borrowing-list.html">

<polymer-element name="uqlibrary-fines" attributes="fines actionButtons" extends="uqlibrary-borrowing-list">

  <template>
    <link rel="stylesheet" href="uqlibrary-borrowing.css">
    <core-signals on-core-signal-transitioning-change="{{transitioningChangeHandler}}"></core-signals>
    <section name="list" class="with-persistent-footer">
      <uqlibrary-borrowing-list id="finesList" items="{{fines}}">
      </uqlibrary-borrowing-list>

      <paper-action-dialog id="finesInfoDialog" transition="core-transition-bottom" backdrop>
        <p>You don't need to pay your overdue charges unless you reach {{fineMinimumPayableAmount | moneyFormat}}. You currently have {{finesSum | moneyFormat}}, so you {{needToPay}} to pay your overdue charges.</p>
        <template repeat="{{button in actionButtons.contextual}}">
          <div>
            <a href="{{button.url}}" target="_blank" id="{{button.id}}" on-click="{{contextualButtonClicked}}">{{button.title}}</a>
          </div>
        </template>
        <paper-button affirmative class="colored" on-tap="{{toggleLogout}}">Okay, I got it</paper-button>
      </paper-action-dialog>

    </section>
    <uqlibrary-persistent-footer id="persistentFooter" actionButtons="{{actionButtons.footer}}" hidden?="{{finesSum == 0}}">
      <div layout horizontal>
        <div flex class="footer-info"> <b>Total</b>: {{finesSum | moneyFormat}} </div>
        <div class="footer-buttons" end-justified>
          <paper-button raised on-tap="{{toggleInfo}}">Info</paper-button>

          <core-tooltip id="tooltip" hidden?="{{ finesSum >= fineMinimumPayableAmount }}" label="No need to pay unless you reach {{fineMinimumPayableAmount | moneyFormat}}" position="left" class="fancy">
                <paper-button class="colored" disabled?="{{ finesSum < fineMinimumPayableAmount }}">Pay now</paper-button>
          </core-tooltip>

          <a target="_blank" hidden?="{{ finesSum < fineMinimumPayableAmount }}" href="https://library.uq.edu.au/patroninfo~S7/{{patronNumber}}/overdues">
            <paper-button class="colored">Pay now</paper-button>
          </a>
        </div>
      </div>
    </uqlibrary-persistent-footer>

  </template>

  <script>
    Polymer('uqlibrary-fines', {

      publish: {
        fines: {
          value : [],
          reflect : true
        },
        actionButtons: {footer: [], contextual: []}
      },
      transitioning: false,
      finesSum: 0,
      fineMinimumPayableAmount: 20 * 100, // in cents
      needToPay: "don't need",
      patronNumber: '',

      ready: function(){
        this.$.finesList.noItemsMessage = "No overdue charges";
        this.$.finesList.showEachDate = true;

      },

      finesChanged: function(){
        this.processData();
        if(this.finesSum < this.fineMinimumPayableAmount) {
          this.actionButtons.footer = [];
        }
        if (this.finesSum >= this.fineMinimumPayableAmount) {
          this.needToPay = "need";
        }

      },

      processData: function() {
        var _fines = [];

        for (var i = 0; i < this.fines.length; i++) {

          var _fine = this.fines[i];
          _fine.class = 'fine-item';
          _fine.id = i;
          _fine.date = new Date(_fine.dateAssessed);
          _fine.day =  this.moneyFormat(_fine.fineAmount);
          _fine.dayPrefixText = '';
          _fine.daySuffixText = '';
          if (_fine.dueDate){
            _fine.dueDate = new Date(_fine.dueDate);
            _fine.dueDateText = _fine.dueDate.getDate() + '/' + (_fine.dueDate.getMonth() + 1) + '/' + _fine.dueDate.getFullYear();
          }
          if (_fine.dateReturned) {
            _fine.dateReturned = new Date(_fine.dateReturned);
            _fine.dateReturnedText = _fine.dateReturned.getDate() + '/' + (_fine.dateReturned.getMonth() + 1) + '/' + _fine.dateReturned.getFullYear();
          }
          _fine.actions = [];

          if(_fine.dueDateText && _fine.dateReturnedText) {
            _fine.subtitle = "Due date: " + _fine.dueDateText;
            _fine.secondaryText = "Date returned: " + _fine.dateReturnedText;
            //if(_fine.description) {
              //_fine.attentionIcon = {icon: "warning", text: _fine.description, type: 'warning'};
            //}
          }
          else {
            if(_fine.description) {
              _fine.subtitle = _fine.description;
            }


          }

          this.finesSum = this.calculateFines(this.fines);
        }
      },

      transitioningChangeHandler: function(e) {
        if(e.detail.hasOwnProperty('transitioning'))
          this.transitioning = e.detail.transitioning;
      },

      calculateFines : function(fines) {
        this.finesSum = 0;
        if(fines && fines.length > 0) {
          for(var i=0; i < fines.length; i++){
            if(fines[i].fineAmount) {
              this.finesSum += parseInt(fines[i].fineAmount);
            }
          }
        }
        return this.finesSum;
      },

      toggleInfo: function() {
        this.$.finesInfoDialog.toggle();
      },

      moneyFormat: function(value) {
        return '$' + (value > 0 ? (parseFloat(value) / 100).toFixed(2) : '0') ;
      }

    });

  </script>

</polymer-element>